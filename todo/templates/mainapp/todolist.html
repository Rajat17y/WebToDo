{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - To-Do</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        #dashboard-container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }
        #navbar {
            background-color: #3273dc;
            color: white;
            padding: 1rem 2rem;
            font-weight: 600;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 6px rgba(50, 50, 93, 0.2);
        }
        #main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        #sidebar {
            width: 220px;
            background-color: #f5f7fa;
            border-right: 1px solid #ddd;
            padding: 1.5rem 1rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        #sidebar .button {
            justify-content: flex-start;
            font-weight: 600;
            color: #3273dc;
            border: 1px solid #3273dc;
            background: white;
            width: 100%;
            margin-bottom: 0.8rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #sidebar .button:hover, #sidebar .button.is-active {
            background-color: #3273dc;
            color: white;
            box-shadow: 0 4px 8px rgba(50, 115, 220, 0.3);
        }
        form#logout-form {
            margin-top: auto;
        }
        #content-area {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background-color: white;
            margin-bottom: 70px;
        }
        
        /* Sortable styles */
        .todo-list {
            list-style: none;
            margin: 0;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dedede;
            border-radius: 8px;
            background-color: #fff;
            margin-bottom: 1rem;
        }
        
        .todo-list li {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #eee;
            font-size: 1rem;
            color: #2a2a2a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            transition: background-color 0.2s ease;
        }
        
        .todo-list li:hover {
            background-color: #f8f9fa;
        }
        
        .todo-list li:last-child {
            border-bottom: none;
        }
        
        .todo-list li.sortable-chosen {
            background-color: #e3f2fd !important;
        }
        
        .todo-list li.sortable-ghost {
            opacity: 0.4;
        }
        
        .task-text {
            flex-grow: 1;
            margin-right: 1rem;
            word-break: break-word;
        }
        
        .drag-handle {
            cursor: move;
            color: #999;
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .drag-handle:hover {
            color: #3273dc;
        }
        
        .task-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s ease;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        /* Fixed input container */
        #input-area {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 800px;
            background: #fff;
            padding: 8px 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            border-radius: 10px;
            display: flex;
            gap: 10px;
            box-sizing: border-box;
            z-index: 20;
        }
        
        #task-input {
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        #task-input:focus {
            border-color: #3273dc;
            box-shadow: 0 0 6px rgba(50, 115, 220, 0.3);
        }
        
        #add-btn {
            background-color: #3273dc;
            border: none;
            color: white;
            font-weight: 700;
            font-size: 1rem;
            padding: 0 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        #add-btn:disabled {
            background-color: #a5b8d1;
            cursor: not-allowed;
        }
        
        #add-btn:hover:enabled {
            background-color: #2759aa;
        }
        
        .reorder-info {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #1565c0;
        }
    </style>
</head>
<body>
    <div id="dashboard-container">
        <!-- Top Navbar -->
        <div id="navbar">
            Welcome, <strong>{{ username }}</strong>
        </div>
        
        <div id="main-content">
            <!-- Sidebar -->
            <aside id="sidebar">
                <button class="button" type="button">Dashboard</button>
                <button class="button is-active" type="button">My To-Do</button>
                <button class="button" type="button">Profile</button>
                <button class="button" type="button">Settings</button>
                <form id="logout-form" method="post" action="{% url 'logout' %}">
                    {% csrf_token %}
                    <button type="submit" class="button is-danger">Logout</button>
                </form>
            </aside>

            <!-- Main Content -->
            <section id="content-area">
                <h1 class="title">My To-Do List</h1>
                
                <div class="reorder-info">
                    <i class="fas fa-info-circle"></i> 
                    You can drag and drop tasks to reorder them. Your order will be automatically saved.
                </div>
                
                <ul class="todo-list" id="todo-list">
                    {% for todo in todos %}
                        <li data-id="{{ todo.id }}" data-order="{{ todo.order_field }}">
                            <div style="display: flex; align-items: center; flex-grow: 1;">
                                <span class="drag-handle">⋮⋮</span>
                                <span class="task-text">{{ todo.task }}</span>
                            </div>
                            <div class="task-actions">
                                <span style="font-size: 12px; color: #666;">Order: {{ todo.order_field }}</span>
                                <form method="post" action="{% url 'delete_task' todo.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="delete-btn" onclick="return confirm('Are you sure you want to delete this task?')">
                                        Delete
                                    </button>
                                </form>
                            </div>
                        </li>
                    {% empty %}
                        <li>No tasks added yet.</li>
                    {% endfor %}
                </ul>
            </section>
        </div>
    </div>

    <!-- Fixed input at bottom center -->
    <form id="input-area" method="post" action="{% url 'todolist' %}">
        {% csrf_token %}
        <input
            type="text"
            id="task-input"
            name="task"
            placeholder="Add a new task..."
            autocomplete="off"
            required
        />
        <button id="add-btn" type="submit" disabled>Add</button>
    </form>

    <script>
        // Enable add button only when input is not empty
        const taskInput = document.getElementById('task-input');
        const addBtn = document.getElementById('add-btn');

        taskInput.addEventListener('input', () => {
            addBtn.disabled = taskInput.value.trim() === '';
        });

        // Initialize SortableJS for drag and drop
        const todoList = document.getElementById('todo-list');
        
        if (todoList && todoList.children.length > 0 && !todoList.querySelector('li').textContent.includes('No tasks')) {
            const sortable = Sortable.create(todoList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                handle: '.drag-handle',
                onEnd: function(evt) {
                    updateTaskOrder();
                }
            });
        }

        function updateTaskOrder() {
            const todoItems = document.querySelectorAll('#todo-list li[data-id]');
            const taskOrders = [];
            
            todoItems.forEach((item, index) => {
                const taskId = item.getAttribute('data-id');
                if (taskId) {
                    taskOrders.push({
                        id: parseInt(taskId),
                        order: index + 1
                    });
                }
            });

            // Send AJAX request to update order
            fetch('{% url "update_task_order" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({ task_orders: taskOrders })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update order numbers in UI
                    todoItems.forEach((item, index) => {
                        const orderSpan = item.querySelector('.task-actions span');
                        if (orderSpan) {
                            orderSpan.textContent = `Order: ${index + 1}`;
                        }
                        item.setAttribute('data-order', index + 1);
                    });
                } else {
                    alert('Failed to update task order: ' + (data.error || 'Unknown error'));
                    location.reload(); // Reload page on error
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update task order');
                location.reload();
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>
